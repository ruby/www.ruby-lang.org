---
layout: news_post
title: "CVE-2014-8080: XML 扩展导致拒绝服务"
author: "zzak"
translator: "AndyHelix"
date: 2014-10-27 12:00:00 +0000
tags: security
lang: zh_cn
---

在 REXML 中无限制的 XML 实体扩展能导致一个 Dos 漏洞。 这一漏洞已经被标记为 [CVE-2014-8080](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-8080)。 我们强烈建议升级您的 Ruby。

## 细节

从一个 XML 文档中读取文字节点的时候， REXML 解析器被强制分配了一个极大的字符串对象，这会消耗掉机器上的全部内存从而导致拒绝服务现象出现。

受影响的程序代码如下所示:

{% highlight ruby %}
require 'rexml/document'

xml = <<XML
<!DOCTYPE root [
  # ENTITY expansion vector
]>
<cd></cd>
XML

p REXML::Document.new(xml)
{% endhighlight %}

使用受影响版本的用户应当立即升级版本或者使用下文列出的一种变通措施。

## 受影响的版本:

* 在 Ruby 1.9.3 patchlevel 550 之前的全部 Ruby 1.9 版本
* 在 Ruby 2.0.0 patchlevel 594 之前的全部 Ruby 2.0 版本
* 在 Ruby 2.1.4 之前的全部 Ruby 2.1 版本
* 在主干版本 48161 之前的版本

## 变通措施

如果你无法升级 Ruby，可以在 Ruby 2.1.0 以上版本中使用如下的猴子补丁 (monkey patch) 作为一种变通措施:

{% highlight ruby %}
class REXML::Entity
  def value
      if @value
        matches = @value.scan(PEREFERENCE_RE)
        rv = @value.clone
        if @parent
          sum = 0
          matches.each do |entity_reference|
            entity_value = @parent.entity( entity_reference[0] )
            if sum + entity_value.bytesize > Security.entity_expansion_text_limit
              raise "entity expansion has grown too large"
            else
              sum += entity_value.bytesize
            end
            rv.gsub!( /%#{entity_reference.join};/um, entity_value )
          end
        end
        return rv
      end
      nil
   end
end
{% endhighlight %}

对于低于 Ruby 2.1.0 的版本，你可以使用如下的猴子补丁 (monkey patch):

{% highlight ruby %}
class REXML::Entity
  def value
      if @value
        matches = @value.scan(PEREFERENCE_RE)
        rv = @value.clone
        if @parent
          sum = 0
          matches.each do |entity_reference|
            entity_value = @parent.entity( entity_reference[0] )
            if sum + entity_value.bytesize > Document.entity_expansion_text_limit
              raise "entity expansion has grown too large"
            else
              sum += entity_value.bytesize
            end
            rv.gsub!( /%#{entity_reference.join};/um, entity_value )
          end
        end
        return rv
      end
      nil
   end
end
{% endhighlight %}

## 致谢
 
感谢 Willis Vandevanter 报告了这一问题。

## 历史 

* 首次发表于二零一四年世界协调时间 (UTC) 十二点零分零秒
