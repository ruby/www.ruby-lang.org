{% if site.data.locales[page.lang].header_navigation %}
  {% assign nav_items = site.data.locales[page.lang].header_navigation %}
{% else %}
  {% assign nav_items = site.data.locales['en'].header_navigation %}
{% endif %}

{% if site.data.locales[page.lang].sidebar %}
  {% assign syndicate = site.data.locales[page.lang].sidebar.syndicate %}
{% else %}
  {% assign syndicate = site.data.locales['en'].sidebar.syndicate %}
{% endif %}

{% comment %}
  Determine navigation section from URL pattern
  Order matters: more specific patterns should come first
{% endcomment %}
{% assign nav_section = nil %}
{% assign current_section_submenu = nil %}
{% assign current_section_title = nil %}

{% if page.url contains '/news/' %}
  {% assign nav_section = 'news' %}
{% elsif page.url contains '/security/' %}
  {% assign nav_section = 'security' %}
{% elsif page.url contains '/downloads/' or page.url contains '/documentation/installation/' %}
  {% assign nav_section = 'install' %}
{% elsif page.url contains '/dev/' or page.url contains '/documentation/repository-guide/' or page.url contains '/community/mailing-lists/' or page.url contains '/community/ruby-core/' %}
  {% assign nav_section = 'contribution' %}
{% elsif page.url contains '/documentation/' or page.url contains '/about/' %}
  {% assign nav_section = 'documentation' %}
{% elsif page.url contains '/libraries/' %}
  {% assign nav_section = 'libraries' %}
{% elsif page.url contains '/community/' or page.url contains '/conduct/' %}
  {% assign nav_section = 'community' %}
{% endif %}

{% comment %}
  Find the matching navigation item and get its submenu
{% endcomment %}
{% for item in nav_items %}
  {% if nav_section == 'install' %}
    {% if item.url contains '/installation/' %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% elsif nav_section == 'documentation' %}
    {% if item.url contains '/documentation/' %}
      {% unless item.url contains '/installation/' %}
        {% assign current_section_submenu = item.submenu %}
        {% assign current_section_title = item.text %}
        {% break %}
      {% endunless %}
    {% endif %}
  {% elsif nav_section == 'libraries' %}
    {% if item.url contains '/libraries/' %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% elsif nav_section == 'contribution' %}
    {% if item.url contains '/dev/' or item.url contains '/ruby-core/' %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% elsif nav_section == 'community' %}
    {% capture community_url %}/{{ page.lang }}/community/{% endcapture %}
    {% if item.url == community_url %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% elsif nav_section == 'news' %}
    {% if item.url contains '/news/' %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if nav_section == 'news' or nav_section == 'security' %}
  {% comment %}
    For news and security sections, show the news sidebar (top nav + year archives + RSS)
  {% endcomment %}
  {% include news-sidebar.html %}
{% else %}
  {% comment %}
    If no section matched, default to documentation section
  {% endcomment %}
  {% unless current_section_submenu %}
    {% for item in nav_items %}
      {% if item.url contains '/documentation/' %}
        {% unless item.url contains '/installation/' %}
          {% assign current_section_submenu = item.submenu %}
          {% assign current_section_title = item.text %}
          {% break %}
        {% endunless %}
      {% endif %}
    {% endfor %}
  {% endunless %}

<div class="md:bg-transparent md:dark:bg-transparent md:p-0 md:border-0">
  <div class="mb-1 hidden md:block border-b border-stone-200 dark:border-stone-700 pb-3">
    <h3 class="text-xs font-semibold text-stone-500 dark:text-stone-400">{{ current_section_title }}</h3>
  </div>

  {% comment %}
    Render submenu items
  {% endcomment %}
  <nav class="space-y-0">
    {% for subitem in current_section_submenu %}
      {% if subitem.submenu %}
        {% comment %}
          Item with nested submenu - check if parent has URL
        {% endcomment %}
        {% if subitem.url %}
          {% comment %}Parent item has URL - show as top-level link with submenu below{% endcomment %}
          {% comment %}Check if current page matches this nav item (exact match or starts with the URL for pagination){% endcomment %}
          {% assign is_active = false %}
          {% if page.url == subitem.url %}
            {% assign is_active = true %}
          {% elsif subitem.external == nil or subitem.external == false %}
            {% assign url_length = subitem.url | size %}
            {% if page.url.size > url_length %}
              {% assign page_url_prefix = page.url | slice: 0, url_length %}
              {% if page_url_prefix == subitem.url %}
                {% comment %}Only match if remaining path starts with a digit (pagination){% endcomment %}
                {% assign remaining = page.url | remove_first: subitem.url %}
                {% assign first_char = remaining | slice: 0, 1 %}
                {% assign digits = "0123456789" %}
                {% if digits contains first_char %}
                  {% assign is_active = true %}
                {% endif %}
              {% endif %}
            {% endif %}
          {% endif %}
          <div class="border-b border-stone-200 dark:border-stone-700">
            <a href="{{ subitem.url }}"
               class="flex items-center justify-between py-4 pl-1 text-base group {% if is_active %}text-semantic-text-link font-bold{% else %}text-stone-900 dark:text-stone-100 hover:text-semantic-text-link-hovered font-bold{% endif %} transition-colors"
               {% if subitem.external %}target="_blank" rel="noopener noreferrer"{% endif %}>
              <span class="{% if subitem.external %}inline-flex items-center gap-1{% endif %}">
                {{ subitem.text }}
                {% if subitem.external %}<span class="icon-external text-xs" aria-hidden="true"></span>{% endif %}
              </span>
              <svg class="w-3 h-3 text-stone-400 dark:text-stone-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </a>
            {% comment %}Show submenu below the parent link{% endcomment %}
            <ul class="space-y-2 list-disc pl-5 pb-6 marker:text-stone-400 dark:marker:text-stone-500">
              {% for nesteditem in subitem.submenu %}
              {% comment %}Check if current page matches this nav item (exact match or starts with the URL for pagination){% endcomment %}
              {% assign nested_is_active = false %}
              {% if page.url == nesteditem.url %}
                {% assign nested_is_active = true %}
              {% elsif nesteditem.external == nil or nesteditem.external == false %}
                {% assign nested_url_length = nesteditem.url | size %}
                {% if page.url.size > nested_url_length %}
                  {% assign nested_page_url_prefix = page.url | slice: 0, nested_url_length %}
                  {% if nested_page_url_prefix == nesteditem.url %}
                    {% comment %}Only match if remaining path starts with a digit (pagination){% endcomment %}
                    {% assign nested_remaining = page.url | remove_first: nesteditem.url %}
                    {% assign nested_first_char = nested_remaining | slice: 0, 1 %}
                    {% assign nested_digits = "0123456789" %}
                    {% if nested_digits contains nested_first_char %}
                      {% assign nested_is_active = true %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}
              <li class="list-item">
                <a href="{{ nesteditem.url }}"
                   class="block py-1 text-sm {% if nested_is_active %}text-semantic-text-link font-normal{% else %}text-stone-900 dark:text-stone-100 hover:text-semantic-text-link-hovered font-normal{% endif %} transition-colors"
                   {% if nesteditem.external %}target="_blank" rel="noopener noreferrer"{% endif %}>
                  {{ nesteditem.text }}{% if nesteditem.external %}<span class="icon-external text-xs inline-block align-baseline ml-0.5" aria-hidden="true"></span>{% endif %}
                </a>
              </li>
              {% endfor %}
            </ul>
          </div>
        {% else %}
          {% comment %}Parent has no URL - show as section header{% endcomment %}
          <div class="{% if forloop.first %}pt-0 mt-0{% else %}pt-6 mt-6{% endif %} border-b border-stone-200 dark:border-stone-700 pb-6">
            <h4 class="text-xs font-semibold text-stone-500 dark:text-stone-400 mb-4 pl-1">{{ subitem.text }}</h4>
            <ul class="space-y-2 list-disc pl-5 marker:text-stone-400 dark:marker:text-stone-500">
              {% for nesteditem in subitem.submenu %}
              {% comment %}Check if current page matches this nav item (exact match or starts with the URL for pagination){% endcomment %}
              {% assign is_active = false %}
              {% if page.url == nesteditem.url %}
                {% assign is_active = true %}
              {% elsif nesteditem.external == nil or nesteditem.external == false %}
                {% assign url_length = nesteditem.url | size %}
                {% if page.url.size > url_length %}
                  {% assign page_url_prefix = page.url | slice: 0, url_length %}
                  {% if page_url_prefix == nesteditem.url %}
                    {% comment %}Only match if remaining path starts with a digit (pagination){% endcomment %}
                    {% assign remaining = page.url | remove_first: nesteditem.url %}
                    {% assign first_char = remaining | slice: 0, 1 %}
                    {% assign digits = "0123456789" %}
                    {% if digits contains first_char %}
                      {% assign is_active = true %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}
              <li class="list-item">
                <a href="{{ nesteditem.url }}"
                   class="block py-1 text-sm {% if is_active %}text-semantic-text-link font-normal{% else %}text-stone-900 dark:text-stone-100 hover:text-semantic-text-link-hovered font-normal{% endif %} transition-colors"
                   {% if nesteditem.external %}target="_blank" rel="noopener noreferrer"{% endif %}>
                  {{ nesteditem.text }}{% if nesteditem.external %}<span class="icon-external text-xs inline-block align-baseline ml-0.5" aria-hidden="true"></span>{% endif %}
                </a>
              </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      {% else %}
        {% comment %}
          Regular submenu item (top level in sidebar)
        {% endcomment %}
        {% comment %}Check if current page matches this nav item (exact match or starts with the URL for pagination){% endcomment %}
        {% assign is_active = false %}
        {% if page.url == subitem.url %}
          {% assign is_active = true %}
        {% elsif subitem.external == nil or subitem.external == false %}
          {% assign url_length = subitem.url | size %}
          {% if page.url.size > url_length %}
            {% assign page_url_prefix = page.url | slice: 0, url_length %}
            {% if page_url_prefix == subitem.url %}
              {% comment %}Only match if remaining path starts with a digit (pagination){% endcomment %}
              {% assign remaining = page.url | remove_first: subitem.url %}
              {% assign first_char = remaining | slice: 0, 1 %}
              {% assign digits = "0123456789" %}
              {% if digits contains first_char %}
                {% assign is_active = true %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}
        <div class="border-b border-stone-200 dark:border-stone-700">
          <a href="{{ subitem.url }}"
             class="flex items-center justify-between py-4 pl-1 text-base group {% if is_active %}text-semantic-text-link font-bold{% else %}text-stone-900 dark:text-stone-100 hover:text-semantic-text-link-hovered font-bold{% endif %} transition-colors"
             {% if subitem.external %}target="_blank" rel="noopener noreferrer"{% endif %}>
            <span class="{% if subitem.external %}inline-flex items-center gap-1{% endif %}">
              {{ subitem.text }}
              {% if subitem.external %}<span class="icon-external text-xs" aria-hidden="true"></span>{% endif %}
            </span>
            <svg class="w-3 h-3 text-stone-400 dark:text-stone-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
      {% endif %}
    {% endfor %}
  </nav>

  <!-- RSS Link Section -->
  {% if syndicate and syndicate.recent_news %}
  <div class="pt-6">
    <p class="pl-1">
      <a href="{{ syndicate.recent_news.url }}" target="_blank" rel="noopener noreferrer" class="text-sm font-normal text-stone-900 dark:text-stone-100 hover:text-semantic-text-link-hovered transition-colors inline-flex items-center gap-1">
        <span class="icon-rss-feed" aria-hidden="true"></span>
        {{ syndicate.recent_news.text }}<span class="icon-external text-xs" aria-hidden="true"></span>
      </a>
    </p>
  </div>
  {% endif %}
</div>
{% endif %}
