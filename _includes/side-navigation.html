{% if site.data.locales[page.lang].header_navigation %}
  {% assign nav_items = site.data.locales[page.lang].header_navigation %}
{% else %}
  {% assign nav_items = site.data.locales['en'].header_navigation %}
{% endif %}

{% comment %}
  Determine navigation section from URL pattern
  Order matters: more specific patterns should come first
{% endcomment %}
{% assign nav_section = nil %}
{% assign current_section_submenu = nil %}
{% assign current_section_title = nil %}

{% if page.url contains '/news/' %}
  {% assign nav_section = 'news' %}
{% elsif page.url contains '/security/' %}
  {% assign nav_section = 'security' %}
{% elsif page.url contains '/downloads/' or page.url contains '/documentation/installation/' %}
  {% assign nav_section = 'install' %}
{% elsif page.url contains '/dev/' or page.url contains '/documentation/repository-guide/' or page.url contains '/community/mailing-lists/' %}
  {% assign nav_section = 'contribution' %}
{% elsif page.url contains '/documentation/' or page.url contains '/about/' %}
  {% assign nav_section = 'documentation' %}
{% elsif page.url contains '/libraries/' %}
  {% assign nav_section = 'libraries' %}
{% elsif page.url contains '/community/' %}
  {% assign nav_section = 'community' %}
{% endif %}

{% comment %}
  Find the matching navigation item and get its submenu
{% endcomment %}
{% for item in nav_items %}
  {% if nav_section == 'install' %}
    {% if item.url contains '/installation/' %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% elsif nav_section == 'documentation' %}
    {% if item.text contains 'ドキュメント' or item.text contains 'Documentation' %}
      {% unless item.url contains '/installation/' %}
        {% assign current_section_submenu = item.submenu %}
        {% assign current_section_title = item.text %}
        {% break %}
      {% endunless %}
    {% endif %}
  {% elsif nav_section == 'libraries' %}
    {% if item.url contains '/libraries/' %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% elsif nav_section == 'contribution' %}
    {% if item.text contains 'コントリビューション' or item.text contains 'Contribution' %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% elsif nav_section == 'community' %}
    {% if item.url contains '/community/' %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% elsif nav_section == 'news' %}
    {% if item.url contains '/news/' %}
      {% assign current_section_submenu = item.submenu %}
      {% assign current_section_title = item.text %}
      {% break %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if nav_section == 'news' or nav_section == 'security' %}
  {% comment %}
    For news and security sections, show the news sidebar (top nav + year archives + RSS)
  {% endcomment %}
  {% include news-sidebar.html %}
{% elsif current_section_submenu %}
<div class="bg-stone-50 dark:bg-stone-800 rounded-lg p-4 md:bg-transparent md:dark:bg-transparent md:p-0 border border-stone-200 dark:border-stone-700 md:border-0">
  <div class="flex justify-between items-center mb-1 md:block border-b border-stone-200 dark:border-stone-700 pb-3">
    <h3 class="text-xs font-semibold text-stone-500 dark:text-stone-400">{{ current_section_title }}</h3>
    <!-- Close button for mobile -->
    <button id="nav-close-btn" class="md:hidden p-2 hover:bg-stone-200 dark:hover:bg-stone-700 rounded-md">
      <span class="material-icons text-base">close</span>
    </button>
  </div>

  {% comment %}
    Render submenu items
  {% endcomment %}
  <nav class="space-y-0">
    {% for subitem in current_section_submenu %}
      {% if subitem.submenu %}
        {% comment %}
          Section with nested submenu
        {% endcomment %}
        <div class="{% if forloop.first %}pt-0 mt-0{% else %}pt-6 mt-6{% endif %} border-b border-stone-200 dark:border-stone-700 pb-6">
          <h4 class="text-xs font-semibold text-stone-500 dark:text-stone-400 mb-4">{{ subitem.text }}</h4>
          <ul class="space-y-2">
            {% for nesteditem in subitem.submenu %}
            <li>
              <a href="{{ nesteditem.url }}"
                 class="block py-1 pl-4 text-sm {% if page.url == nesteditem.url %}text-semantic-text-link font-normal{% else %}text-stone-900 dark:text-stone-100 hover:text-semantic-text-link-hovered font-normal{% endif %} transition-colors {% if nesteditem.external %}inline-flex items-center gap-1{% endif %}"
                 {% if nesteditem.external %}target="_blank" rel="noopener noreferrer"{% endif %}>
                {{ nesteditem.text }}
                {% if nesteditem.external %}<span class="icon-external text-xs" aria-hidden="true"></span>{% endif %}
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
      {% else %}
        {% comment %}
          Regular submenu item (top level in sidebar)
        {% endcomment %}
        <div class="border-b border-stone-200 dark:border-stone-700">
          <a href="{{ subitem.url }}"
             class="flex items-center justify-between py-3 text-sm group {% if page.url == subitem.url %}text-semantic-text-link font-bold{% else %}text-stone-900 dark:text-stone-100 hover:text-semantic-text-link-hovered font-bold{% endif %} transition-colors"
             {% if subitem.external %}target="_blank" rel="noopener noreferrer"{% endif %}>
            <span class="{% if subitem.external %}inline-flex items-center gap-1{% endif %}">
              {{ subitem.text }}
              {% if subitem.external %}<span class="icon-external text-xs" aria-hidden="true"></span>{% endif %}
            </span>
            <svg class="w-3 h-3 text-stone-400 dark:text-stone-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
      {% endif %}
    {% endfor %}
  </nav>
</div>
{% else %}
  {% comment %}
    Fallback to original navigation if no section match found
  {% endcomment %}
  {% include navigation.html %}
{% endif %}
