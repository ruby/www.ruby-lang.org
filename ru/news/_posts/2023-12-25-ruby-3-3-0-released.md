---
layout: news_post
title: "Выпуск Ruby 3.3.0"
author: "naruse"
translator:
date: 2023-12-25 00:00:00 +0000
lang: ru
---

{% assign release = site.data.releases | where: "version", "3.3.0" | first %}
Мы рады объявить о выпуске Ruby {{ release.version }}. Ruby 3.3 добавляет новый парсер под названием Prism, использует Lrama в качестве генератора парсеров, вводит новый чисто-рубиновый JIT-компилятор под названием RJIT и множество улучшений производительности, особенно YJIT.

## Prism

* Введен [парсер Prism](https://github.com/ruby/prism) в качестве гема по умолчанию
    * Prism является портативным, терпимым к ошибкам и поддерживаемым рекурсивным спуском парсером для языка Ruby
* Prism готов к использованию в продакшн и активно поддерживается, его можно использовать вместо Ripper
    * Доступна [обширная документация](https://ruby.github.io/prism/) о том, как использовать Prism
    * Prism представляет собой как C-библиотеку, которая будет использоваться внутренне CRuby, так и Ruby гем, который может использоваться любыми инструментами, требующими разбора Ruby-кода
    * Заметные методы в API Prism:
        * `Prism.parse(source)`, который возвращает AST как часть объекта результата разбора
        * `Prism.parse_comments(source)`, который возвращает комментарии
        * `Prism.parse_success?(source)`, который возвращает true, если ошибок нет
* Если вас интересует внесение вклада, вы можете создать pull request или issue напрямую в [репозитории Prism](https://github.com/ruby/prism)
* Теперь вы можете использовать `ruby --parser=prism` или `RUBYOPT="--parser=prism"` для экспериментов с компилятором Prism. Обратите внимание, что этот флаг предназначен только для отладки.

## Использование Lrama вместо Bison

* Замена Bison на [генератор парсера Lrama LALR](https://github.com/ruby/lrama) [[Feature #19637]](https://bugs.ruby-lang.org/issues/19637)
  * Если вас интересует, пожалуйста, ознакомьтесь с [Будущим видением парсера Ruby](https://rubykaigi.org/2023/presentations/spikeolaf.html)
  * Внутренний парсер Lrama заменен на LR парсер, сгенерированный Racc для улучшения поддерживаемости
  * Поддерживаются параметризованные правила `(?, *, +)`, которые будут использоваться в Ruby parse.y

## YJIT

* Существенные улучшения производительности по сравнению с Ruby 3.2
  * Поддержка распаковки и оставшихся аргументов была значительно улучшена.
  * Регистры выделяются для операций со стеком виртуальной машины.
  * Компилируются больше вызовов с необязательными аргументами. Также компилируются обработчики исключений.
  * Неподдерживаемые типы вызовов и мегаморфные сайты вызовов больше не переходят к интерпретатору.
  * Основные методы, такие как Rails `#blank?` и [специализированный `#present?`](https://github.com/rails/rails/pull/49909), встраиваются.
  * `Integer#*`, `Integer#!=`, `String#!=`, `String#getbyte`,
    `Kernel#block_given?`, `Kernel#is_a?`, `Kernel#instance_of?`, и `Module#===`
    особенно оптимизированы.
  * Скорость компиляции теперь немного выше, чем в Ruby 3.2.
  * Теперь более чем в 3 раза быстрее интерпретатора на Optcarrot!
* Значительно улучшено использование памяти по сравнению с Ruby 3.2
    * Метаданные для скомпилированного кода используют гораздо меньше памяти.
    * `--yjit-call-threshold` автоматически повышается с 30 до 120
      при наличии более 40 000 ISEQs в приложении.
    * Добавлен `--yjit-cold-threshold`, чтобы пропускать компиляцию холодных ISEQ.
    * На Arm64 генерируется более компактный код.
* Кодовый GC теперь отключен по умолчанию
  * `--yjit-exec-mem-size` рассматривается как жесткий лимит, при котором компиляция нового кода прекращается.
  * Нет резких падений производительности из-за кодового GC.
    Лучшее поведение при копировании при перезапуске серверов с
    [Pitchfork](https://github.com/shopify/pitchfork).
  * Вы все еще можете включить кодовый GC при необходимости с помощью `--yjit-code-gc`
* Добавлена возможность `RubyVM::YJIT.enable`, которая позволяет включить YJIT во время выполнения
  * Вы можете запустить YJIT, не изменяя аргументов командной строки или переменных среды.
    Rails 7.2 будет [включать YJIT по умолчанию](https://github.com/rails/rails/pull/49947)
    с использованием этого метода.
  * Это также можно использовать для включения YJIT только после завершения загрузки вашего приложения.
    `--yjit-disable` можно использовать, если вы хотите использовать другие параметры YJIT, отключив его при загрузке.
* Дополнительные статистики YJIT теперь доступны по умолчанию
  * `yjit_alloc_size` и несколько других статистик, связанных с метаданными, теперь доступны по умолчанию.
  * Статистика `ratio_in_yjit`, получаемая с помощью `--yjit-stats`, теперь доступна в релизных сборках,
    для доступа к большинству статистик больше не требуется специальная статистическая или разработочная сборка.
* Добавлены дополнительные возможности профилирования
  * Добавлено `--yjit-perf` для упрощения профилирования с использованием Linux perf.
  * `--yjit-trace-exits` теперь поддерживает выборку с `--yjit-trace-exits-sample-rate=N`
* Проведено более тщательное тестирование и множество исправлений ошибок

## RJIT

* Введен чисто-рубиновый JIT-компилятор RJIT, заменивший MJIT.
  * RJIT поддерживает только архитектуру x86-64 на платформах Unix.
  * В отличие от MJIT, он не требует компилятора C во время выполнения.
* RJIT существует исключительно в экспериментальных целях.
  * В продакшене рекомендуется продолжать использовать YJIT.
* Если вас интересует разработка JIT для Ruby, обратитесь к [презентации k0kubun на Day 3 RubyKaigi](https://rubykaigi.org/2023/presentations/k0kubun.html#day3).

### Планировщик потоков M:N

* Введен планировщик потоков M:N. [[Feature #19842]](https://bugs.ruby-lang.org/issues/19842)
  * Потоки M Ruby управляются N нативными потоками (потоками ОС), что снижает затраты на создание и управление потоками.
  * Это может нарушить совместимость с C-расширениями, поэтому планировщик потоков M:N по умолчанию отключен в основном Ractor.
      * Переменная среды `RUBY_MN_THREADS=1` активирует потоки M:N в основном Ractor.
      * Потоки M:N включены в неосновных Ractor.
  * Переменная среды `RUBY_MAX_CPU=n` устанавливает максимальное количество `N` (максимальное количество нативных потоков). По умолчанию это значение равно 8.
      * Поскольку только один Ruby-поток на Ractor может работать одновременно, будет использовано меньшее из числа, указанного в `RUBY_MAX_CPU`, и числа запущенных Ractor. Таким образом, большинство приложений с одним Ractor будут использовать 1 нативный поток.
      * Для поддержки блокирующих операций может использоваться больше `N` нативных потоков.

## Улучшения производительности

* `defined?(@ivar)` оптимизирован с использованием объектных форм.
* Разрешение имени, такое как `Socket.getaddrinfo`, теперь может быть прервано (в средах, где доступны pthreads). [[Feature #19965]](https://bugs.ruby-lang.org/issues/19965)
* Несколько улучшений производительности для сборщика мусора
  * Молодые объекты, на которые ссылаются старые объекты, больше не сразу
    переводятся в старшее поколение. Это значительно снижает частоту
    основных сборок мусора. [[Feature #19678]](https://bugs.ruby-lang.org/issues/19678)
  * Введена новая настройка `REMEMBERED_WB_UNPROTECTED_OBJECTS_LIMIT_RATIO`
    для контроля числа незащищенных объектов, вызывающих основную сборку мусора.
    По умолчанию установлено значение `0.01` (1%). Это значительно
    снижает частоту основной сборки мусора. [[Feature #19571]](https://bugs.ruby-lang.org/issues/19571)
  * Для многих основных типов были введены барьеры записи, которых ранее не было,
    особенно для `Time`, `Enumerator`, `MatchData`, `Method`, `File::Stat`, `BigDecimal`
    и нескольких других. Это значительно сокращает время минорных сборок мусора и частоту
    основных сборок мусора.
  * Большинство основных классов теперь используют переменную ширину выделения, в частности `Hash`, `Time`,
    `Thread::Backtrace`, `Thread::Backtrace::Location`, `File::Stat`, `Method`.
    Это делает эти классы быстрее для выделения и освобождения памяти, уменьшает использование памяти и снижает
    фрагментацию кучи.
  * Добавлена поддержка слабых ссылок в сборщик мусора. [[Feature #19783]](https://bugs.ruby-lang.org/issues/19783)

## Другие значимые изменения с момента версии 3.2

### IRB

IRB получил несколько улучшений, включая, но не ограничиваясь:

* Расширенная интеграция `irb:rdbg`, обеспечивающая аналогичный опыт отладки, как в `pry-byebug` ([документация](https://github.com/ruby/irb#debugging-with-irb)).
* Поддержка пейджера для команд `ls`, `show_source` и `show_cmds`.
* Более точная и полезная информация от команд `ls` и `show_source`.
* Экспериментальное автодополнение с использованием анализа типов ([документация](https://github.com/ruby/irb#type-based-completion)).
* Теперь возможно изменять цвет шрифта и стиль шрифта в диалоге автодополнения с помощью введенного недавно класса Reline::Face ([документация](https://github.com/ruby/ruby/blob/master/doc/reline/face.md))

Кроме того, IRB также претерпел обширную рефакторизацию и получил десятки исправлений ошибок для упрощения будущих улучшений.

Для более подробных обновлений обратитесь к статье [Раскрытие большого прорыва в IRB для Ruby 3.3](https://railsatscale.com/2023-12-19-irb-for-ruby-3-3/).

## Проблемы совместимости

Примечание: Исключая исправления ошибок функций.

* Вызовы `it` без аргументов в блоке без обычных параметров считаются устаревшими. В Ruby 3.4 `it` будет ссылаться на первый параметр блока. [[Feature #18980]](https://bugs.ruby-lang.org/issues/18980)

* `Regexp::new` теперь принимает только до 2 аргументов вместо 3. Это было устаревшим с Ruby 3.2. [[Bug #18797]](https://bugs.ruby-lang.org/issues/18797)

### Удаленные переменные среды

Следующие устаревшие методы среды удалены.

* Переменная среды `RUBY_GC_HEAP_INIT_SLOTS` была устаревшей и не выполняла никаких действий. Вместо нее теперь используются переменные среды `RUBY_GC_HEAP_{0,1,2,3,4}_INIT_SLOTS`. [[Feature #19785]](https://bugs.ruby-lang.org/issues/19785)

## Проблемы совместимости в стандартной библиотеке

### `ext/readline` устарел

* Мы имеем `reline`, чистую реализацию на Ruby, совместимую с API `ext/readline`. Мы будем полагаться на `reline` в будущем. Если вам нужно использовать `ext/readline`, вы можете установить `ext/readline` через rubygems.org с помощью `gem install readline-ext`.
* Нам больше не нужно устанавливать библиотеки типа `libreadline` или `libedit`.

## Обновления стандартной библиотеки

RubyGems и Bundler предупреждают, если пользователи используют `require` для следующих гемов без добавления их в Gemfile или gemspec. Это связано с тем, что они станут встроенными гемами в будущих версиях Ruby.

Это предупреждение подавляется при использовании гема bootsnap. Мы рекомендуем запустить ваше приложение хотя бы один раз с переменной среды `DISABLE_BOOTSNAP=1`. Это ограничение текущей версии.

Список целевых библиотек:
  * abbrev
  * base64
  * bigdecimal
  * csv
  * drb
  * getoptlong
  * mutex_m
  * nkf
  * observer
  * racc
  * resolv-replace
  * rinda
  * syslog

Добавлен следующий встроенный гем:

* prism 0.19.0

Обновлены следующие встроенные гемы:

* RubyGems 3.5.3
* abbrev 0.1.2
* base64 0.2.0
* benchmark 0.3.0
* bigdecimal 3.1.5
* bundler 2.5.3
* cgi 0.4.1
* csv 3.2.8
* date 3.3.4
* delegate 0.3.1
* drb 2.2.0
* english 0.8.0
* erb 4.0.3
* error_highlight 0.6.0
* etc 1.4.3
* fcntl 1.1.0
* fiddle 1.1.2
* fileutils 1.7.2
* find 0.2.0
* getoptlong 0.2.1
* io-console 0.7.1
* io-nonblock 0.3.0
* io-wait 0.3.1
* ipaddr 1.2.6
* irb 1.11.0
* json 2.7.1
* logger 1.6.0
* mutex_m 0.2.0
* net-http 0.4.0
* net-protocol 0.2.2
* nkf 0.1.3
* observer 0.1.2
* open-uri 0.4.1
* open3 0.2.1
* openssl 3.2.0
* optparse 0.4.0
* ostruct 0.6.0
* pathname 0.3.0
* pp 0.5.0
* prettyprint 0.2.0
* pstore 0.1.3
* psych 5.1.2
* rdoc 6.6.2
* readline 0.0.4
* reline 0.4.1
* resolv 0.3.0
* rinda 0.2.0
* securerandom 0.3.1
* set 1.1.0
* shellwords 0.2.0
* singleton 0.2.0
* stringio 3.1.0
* strscan 3.0.7
* syntax_suggest 2.0.0
* syslog 0.1.2
* tempfile 0.2.1
* time 0.3.0
* timeout 0.4.1
* tmpdir 0.2.0
* tsort 0.2.0
* un 0.3.0
* uri 0.13.0
* weakref 0.1.3
* win32ole 1.8.10
* yaml 0.3.0
* zlib 3.1.0

Следующий встроенный гем перенесен из списка встроенных гемов:

* racc 1.7.3

Обновлены следующие встроенные гемы:

* minitest 5.20.0
* rake 13.1.0
* test-unit 3.6.1
* rexml 3.2.6
* rss 0.3.0
* net-ftp 0.3.3
* net-imap 0.4.9
* net-smtp 0.4.0
* rbs 3.4.0
* typeprof 0.21.9
* debug 1.9.1

Для получения дополнительной информации о стандартных и пакетных гемах обратитесь к GitHub-релизам, таким как [Logger](https://github.com/ruby/logger/releases) или к изменениям в журнале изменений.

Подробности о новостях смотрите в [NEWS](https://github.com/ruby/ruby/blob/{{ release.tag }}/NEWS.md)
или [логах коммитов](https://github.com/ruby/ruby/compare/v3_2_0...{{ release.tag }})
для получения дополнительной информации.

С учетом этих изменений, [{{ release.stats.files_changed }} файлов изменено, {{ release.stats.insertions }} добавлено(+), {{ release.stats.deletions }} удалено(-)](https://github.com/ruby/ruby/compare/v3_2_0...{{ release.tag }}#file_bucket)
с момента Ruby 3.2.0!

Счастливого Рождества, счастливых праздников и наслаждайтесь программированием на Ruby 3.3!

## Скачать

* <{{ release.url.gz }}>

      SIZE: {{ release.size.gz }}
      SHA1: {{ release.sha1.gz }}
      SHA256: {{ release.sha256.gz }}
      SHA512: {{ release.sha512.gz }}

* <{{ release.url.xz }}>

      SIZE: {{ release.size.xz }}
      SHA1: {{ release.sha1.xz }}
      SHA256: {{ release.sha256.xz }}
      SHA512: {{ release.sha512.xz }}

* <{{ release.url.zip }}>

      SIZE: {{ release.size.zip }}
      SHA1: {{ release.sha1.zip }}
      SHA256: {{ release.sha256.zip }}
      SHA512: {{ release.sha512.zip }}

## Что такое Ruby

Ruby был разработан Мацем (Юкихиро Мацумото) в 1993 году и сейчас развивается как открытое программное обеспечение. Он работает на множестве платформ и широко используется по всему миру, особенно в веб-разработке.
